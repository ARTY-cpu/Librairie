name: Build and Release

on:
  push:
    branches:
      - master
  workflow_dispatch:
  
jobs:
  build:
    runs-on: windows-latest
    permissions: write-all # this is the FIX

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x

    - name: Restore dependencies
      run: dotnet restore
      working-directory: Librairie\Librairie

    - name: Build
      run: dotnet build --configuration Release
      working-directory: Librairie\Librairie

    - name: Debug Environment Variables and File Listing
      run: |
        env
        Get-ChildItem -Path 'Librairie\Librairie\bin\Release\net6.0-windows' -Recurse

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        files: Librairie\Librairie\bin\Release\net6.0-windows\*
        tag_name: ${{ github.run_number }}
        name: Release ${{ github.run_number }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: List Files in Release Directory
      run: Get-ChildItem -Path 'Librairie\Librairie\bin\Release\net6.0-windows\' -Recurse
      
    - name: Upload Release Asset
      id: upload-release-asset
      run: |
        $uploadUrl = "https://uploads.github.com/repos/ARTY-cpu/Librairie/releases/137900969/assets?name=Librairie.exe"
        $files = Get-ChildItem -Path .\Librairie\Librairie\bin\Release\net6.0-windows\* -File
    
        foreach ($file in $files) {
          Write-Host "Uploading $($file.FullName)..."
          Invoke-RestMethod -Uri $uploadUrl -Method Post -Headers @{
            Authorization = "token $env:GITHUB_TOKEN"
          } -InFile $file.FullName -ContentType 'application/octet-stream'
          Write-Host "Uploaded $($file.FullName)."
        }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
